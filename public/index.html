<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
    <title>DTAIE | Digital Estate Executor</title>

    <!-- Loads Ethers.js for Blockchain interaction -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js" type="module"></script>
    <!-- Loads Tailwind CSS for clean, modern styling -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

    <style>
        /* Custom style to make the status badge pop */
        .status-badge {
            transition: all 0.5s ease-in-out;
        }

        .disabled {
            cursor: not-allowed;
        }
    </style>
</head>

<body class="bg-gray-900 text-white font-sans">
    <div class="container mx-auto px-4 py-12 max-w-3xl">
        <!-- Header -->
        <div class="text-center mb-10">
            <h1 class="text-5xl font-extrabold text-blue-400 mb-2">DTAIE</h1>
            <p class="text-gray-400 uppercase tracking-widest text-sm">AI-Verified Digital Estate Executor</p>
        </div>

        <!-- Vault Card (The Main Demo Focus) -->
        <div class="bg-gray-800 rounded-3xl p-8 shadow-2xl border border-gray-700">
            <div class="flex justify-between items-center mb-8">
                <span id="statusBadge"
                    class="bg-yellow-900 text-yellow-300 px-4 py-1 rounded-full text-sm font-bold uppercase">LOCKED
                    ðŸ”’</span>
                <button id="connectBtn"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-xl text-sm font-bold transition shadow-md">Connect
                    Wallet</button>
            </div>

            <div class="space-y-6">
                <div>
                    <label class="text-gray-400 text-sm">Flare Contract Address</label>
                    <p id="contractAddr" class="font-mono text-sm break-all text-gray-300 bg-gray-900 p-2 rounded-lg">
                        Not Loaded</p>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-900 p-4 rounded-2xl">
                        <label class="text-gray-500 text-xs block mb-1">Current Vault Balance (Flare)</label>
                        <span id="balance" class="text-2xl font-bold">0.00</span> <span
                            class="text-gray-400">CFLR</span>
                    </div>
                    <div class="bg-gray-900 p-4 rounded-2xl">
                        <label class="text-gray-500 text-xs block mb-1">AI Verification Status</label>
                        <span id="aiStatus" class="text-xl font-bold text-red-400">Awaiting Email...</span>
                    </div>
                </div>

                <div id="statusMessage"
                    class="bg-gray-700 p-4 rounded-xl text-sm text-gray-300 text-center h-16 flex items-center justify-center">
                    Connect wallet to initialize the system.
                </div>

                <button id="claimBtn"
                    class="w-full py-4 rounded-2xl font-bold text-lg transition shadow-lg transition duration-300 ease-in-out bg-gray-600">Execute
                    Trust Transfer</button>
                <button id="mailStatusBtn"
                    class="w-full py-4 rounded-2xl font-bold text-lg transition shadow-lg transition duration-300 ease-in-out bg-gray-600">Check
                    Mail Status</button>
            </div>
        </div>

        <!-- Sponsor Footer (To impress everyone) -->
        <div class="mt-10 text-center">
            <p class="text-gray-500 text-xs mb-4">This project leverages:</p>
            <div class="flex justify-center space-x-8 opacity-80 grayscale">
                <span class="text-lg font-bold text-blue-300">Flare</span>
                <span class="text-lg font-bold text-purple-300">Plasma (Privacy)</span>
                <span class="text-lg font-bold text-yellow-300">Sui (UX Focus)</span>
                <span class="text-lg font-bold text-white">Ledger (Security)</span>
            </div>
        </div>
    </div>

    <script>
        // === MASTER CONFIG - PASTE YOUR DATA HERE ===
        // 1. PASTE YOUR FLARE CONTRACT ADDRESS HERE (from Remix)
        const CONTRACT_ADDRESS = "0xb685d868f4AFE791aAE73A9D292A366932fF89c3"; // <-- PASTE YOUR FLARE DEPLOYED ADDRESS HERE (The one you just got!)

        // --- VARIABLES ---
        let signer;
        let provider;
        let contractInstance;
        let isConnected = false;
        let claimable = false;
        const FIRE_TIME = 5000; // 5 seconds delay for dramatic effect
        let mailStatus = false;


        document.getElementById('claimBtn').classList.add("disabled");

        // --- 1. WALLET CONNECTION (Connects to Flare) ---
        document.getElementById('connectBtn').onclick = async () => {
            if (window.ethereum) {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                const addr = await signer.getAddress();

                // Set UI elements
                document.getElementById('contractAddr').innerText = CONTRACT_ADDRESS.substring(0, 10) + '...';
                statusMessage.innerText = "Wallet Connected. Checking Vault Balance...";
                connectBtn.innerText = "Connected: " + addr.substring(0, 6) + "...";

                // Read Balance from Flare Contract
                // NOTE: The contract ABI is simplified here for quick demo
                const contractABI = [
                    "function getBalance() view returns (uint256)"
                ];
                contractInstance = new ethers.Contract(CONTRACT_ADDRESS, contractABI, signer);
                // const balance = await contractInstance.getBalance();
                // document.getElementById('balance').innerText = ethers.utils.formatEther(balance);

                // Enable listening state
                isConnected = true;
                claimable = true;
                statusMessage.innerText = "Vault Ready. Waiting for n8n Webhook Signal...";
                listenForWebhook();

            } else {
                alert("Please install MetaMask and switch to Flare Coston2!");
            }
        };


        // --- LISTEN FOR THE SIGNAL ONCE THE PAGE LOADS ---
        // We set up a simple listener that continuously checks the n8n URL

        // --- 2. THE WEBHOOK LISTENER (Connects to n8n) ---
        // This function is called when you click the "Execute Trust Transfer" button 
        // after the n8n workflow has successfully validated the email.
        async function listenForWebhook() {
            if (!isConnected || !claimable) {
                statusMessage.innerText =
                    "ERROR: Wallet not connected or system not ready.";
                return;
            }

            if (!mailStatus) {
                statusMessage.innerText =
                    "Please verify the email first by clicking 'Check Mail Status'.";
                return;
            }

            // Simulate ZK-Proof Generation and Wait (For demo effect)
            await new Promise((resolve) => setTimeout(resolve, 2000)); // Wait 2 seconds

            // Step B: Call the Smart Contract (The Final Action)
            try {
                statusMessage.innerText =
                    "Sending Transaction to Flare Network... (Executing Trust)";

                // THIS IS THE LINE THAT CALLS YOUR FLARE CONTRACT
                const tx = await contractInstance.executeTrust({
                    // For this demo, we pass dummy data, as the main trigger is the webhook itself
                    gasLimit: 300000,
                });

                await tx.wait(); // Wait for the transaction to confirm on Flare

                // If successful: UNLOCK!
                unlockVault();
            } catch (error) {
                console.error(error);
                statusMessage.innerText =
                    "ERROR: Contract Execution Failed. Check Console.";
                document.getElementById("statusBadge").innerText = "Error âŒ";
                document.getElementById("statusBadge").className =
                    "bg-red-800 text-white px-4 py-1 rounded-full text-sm font-bold uppercase";
            }
        }

        // --- 3. THE UNLOCK ACTION (Final State) ---
        function unlockVault() {
            document.getElementById('statusBadge').innerText = "Unlocked ðŸ”“";
            document.getElementById('statusBadge').className = "bg-green-600 text-white px-4 py-1 rounded-full text-sm font-bold uppercase";
            statusMessage.innerText = "SUCCESS: Trust Executed Instantly on Flare!";
            document.getElementById('claimBtn').classList.remove("disabled");
        }

        document.getElementById('claimBtn').onclick = () => {
            claimBtn.innerText = "Transfer Complete!";
        }

        // --- 3. LISTEN FOR N8N WEBHOOK (The Final Connection) ---
        // This function listens for the signal from the n8n Webhook URL
        async function fetchWebhookSignal() {
            try {
                const response = await fetch("/data", {
                    method: "GET",
                });
                console.log("Webhook Response:", response);

                // If status 200
                if (response.ok) {
                    mailStatus = true;
                    document.getElementById('mailStatusBtn').classList.add("disabled");
                    // Step A: Simulate the AI/IF check passed and Webhook fired
                    aiStatus.innerText = "AI Verification: VALID";
                    aiStatus.className = "text-xl font-bold text-yellow-300";
                    if (!isConnected) {
                        statusMessage.innerText =
                            "Webhook Signal Received, but Wallet not connected!";
                        return;
                    } else {
                        statusMessage.innerText =
                            "Signal Received! Preparing Smart Contract Execution...";
                    }
                    // Trigger the unlock sequence on the website!
                    listenForWebhook();
                }
            } catch (error) {
                console.info("Webhook Call to n8n Failed:", error);
            }
        }

        fetchWebhookSignal();

        document.getElementById('mailStatusBtn').onclick = () => {
            fetchWebhookSignal();
        };

    </script>
</body>

</html>